{
  "hash": "6edbd814180cafda2a7bf83fc75da956",
  "result": {
    "markdown": "---\ndraft: true\ntitle: Tracking hummingbirds at the feeder\ndate: 2023-03-17\nauthor: Cait Harrigan\nimage: thumbnail.jpg\ntoc: true\ncategories:\n  - birds\n  - code\n  - data analysis\nformat:\n  html:\n      code-fold: true\n\n---\n\n\nReading time: 12 minutes\n\n# Background\n\nThere are two species of hummingbirds found near Galiano: the green [Anna's Hummingbird ](https://en.wikipedia.org/wiki/Anna%27s_hummingbird) and the orange [Rufous Hummingbird](https://en.wikipedia.org/wiki/Rufous_hummingbird). \n\n\n::: {layout-ncol=2}\n![](anna_id.png)\n\n![](rufous_id.png)\n\nID images from https://www.allaboutbirds.org/\n:::\n\n\n\nWe set up a camera to capture these feathery fellows visiting our hummingbird feeder.\n\n![A Female Anna's (left) and Male Rufus (right) at our feeder](ar_2.jpg)\n\nWe trained a classifier to detect who's who....\n\n::: {layout-ncol=3}\n![](2021-06-10_1201_hbird.jpg)\n\n![](2021-09-06_1243_hbird.jpg)\n\n![](2021-09-06_1930_hbird.jpg)\n:::\n\nAnd we're even able to keep track of when the feeder needs a refill! \n\n<center>\n![](water_level.gif){width=400}\n</center>\n<br>\n\nBut we'll save the details for a future blog post ðŸ˜„\n\nFor now, lets dive in to some of the data we've collected!\n\n\n# Setup\n\nWe'll read in our data: weather from our weather station, and the classifier output as well as bounding boxes of detected birds. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(patchwork)\nlibrary(ggpubr)\n\nweather <- read_csv('https://github.com/teaswamp-creations/galiwatch.ca/raw/quarto-website/posts/hummer-watch/WS_hours.csv') %>%\n  distinct() %>%\n  mutate(Date = ymd(Date), \n         MergeTime = ymd_hms(paste(Date, Time)),\n         `Temp C` = (`Outdoor Temperature F`-32) * (5/9)\n         )\n\n \nclasses = c('Rufous_Male','Annas_Male','Person', 'Annas_Female', 'Rufous_Female')\n\n# read in bird detection data, and do some basic data cleaning\nbird <- read_csv('https://raw.githubusercontent.com/teaswamp-creations/galiwatch.ca/quarto-website/posts/hummer-watch/2021_reprocessed_hummers_combo_2023.csv') %>% \n  mutate(class = classes[label + 1]) %>%\n  separate(class, into=c('Species', 'Sex'), sep='_') %>%\n  separate(image, into=c('Date', 'image'), sep=\"_\") %>%\n  separate(image, into=c('hhmm'), sep=\".jpg\", extra = 'drop') %>%\n  mutate(Timestamp = ymd_hm(paste(Date, hhmm))) %>%\n  filter(label != 2) %>%\n  drop_na() %>%\n  mutate(Date=ymd(Date),\n         Species = ordered(Species),\n         Sex = factor(Sex),\n         ymax = max(ymax) - ymax,\n         ymin = max(ymax) - ymin,\n         MergeTime = floor_date(Timestamp, 'hour')\n  ) \n```\n:::\n\n\nLets take a peek at the data. The air quality measures show the concentration of particulates at three different size thresholds (in micrometers), as well as the outdoor air temperature recorded from April - December 2021.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::kable(head(weather))\n```\n\n::: {.cell-output-display}\n|Date       |Time     | Indoor Temperature F| Indoor Humidity %| Outdoor Temperature F| Outdoor Humidity %| Wind Speed(mph)| wind direction(Degree)| Light Intensity| UV index|Daily Rainfall accumulation | Total Accumulative Rainfall|Strike Count now |Daily Strike Count |Total Strike Count | Closet Strike distance|Interference | barometric Pressure(real)| Calibrated barometric Pressure|Dew Point | Rain Rate| wind gust| Wind Speed average| Feels like|Heat Index |Wind Chill |...27 |MergeTime           |   Temp C|\n|:----------|:--------|--------------------:|-----------------:|---------------------:|------------------:|---------------:|----------------------:|---------------:|--------:|:---------------------------|---------------------------:|:----------------|:------------------|:------------------|----------------------:|:------------|-------------------------:|------------------------------:|:---------|---------:|---------:|------------------:|----------:|:----------|:----------|:-----|:-------------------|--------:|\n|2021-02-14 |19:00:00 |                   62|                51|                  60.7|                 47|               0|                     93|               0|        0|0                           |                           0|--               |--                 |--                 |                      0|--           |                     29.62|                          29.91|38        |         0|         0|                  0|         58|--         |--         |NA    |2021-02-14 19:00:00 | 15.94444|\n|2021-02-14 |20:00:00 |                   63|                51|                  62.8|                 48|               0|                     93|               0|        0|0                           |                           0|--               |--                 |--                 |                      0|--           |                     29.59|                          29.89|42        |         0|         0|                  0|         61|--         |--         |NA    |2021-02-14 20:00:00 | 17.11111|\n|2021-02-14 |21:00:00 |                   66|                50|                  68.7|                 46|               0|                     99|               0|        0|0                           |                           0|--               |--                 |--                 |                      0|--           |                     29.58|                          29.89|46        |         0|         0|                  0|         67|--         |--         |NA    |2021-02-14 21:00:00 | 20.38889|\n|2021-02-14 |22:00:00 |                   67|                51|                  72.0|                 42|               0|                     99|               0|        0|0                           |                           0|--               |--                 |--                 |                      0|--           |                     29.58|                          29.90|47        |         0|         0|                  0|         71|--         |--         |NA    |2021-02-14 22:00:00 | 22.22222|\n|2021-02-14 |23:00:00 |                   67|                51|                  72.1|                 42|               0|                     99|               0|        0|0                           |                           0|--               |--                 |--                 |                      0|--           |                     29.56|                          29.88|47        |         0|         0|                  0|         71|--         |--         |NA    |2021-02-14 23:00:00 | 22.27778|\n|2021-02-15 |00:00:00 |                   67|                51|                  72.8|                 41|               0|                     99|               0|        0|--.--                       |                           0|--               |--                 |--                 |                      0|--           |                     29.54|                          29.87|46        |         0|         0|                  0|         72|--         |--         |NA    |2021-02-15 00:00:00 | 22.66667|\n:::\n:::\n\n\nThe bird detector gives us the the bounding box of each bird in an image, and the predicted sex and species of the bird. Note that because it's hard to distinguish female birds from the immature males, there are likely some which are misclassified. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::kable(head(bird))\n```\n\n::: {.cell-output-display}\n|Date       |hhmm | xmin| ymin| xmax| ymax| label| confidence| x_size| y_size|Mo | OK|Species |Sex  |Timestamp           |MergeTime           |\n|:----------|:----|----:|----:|----:|----:|-----:|----------:|------:|------:|:--|--:|:-------|:----|:-------------------|:-------------------|\n|2021-04-20 |1651 |  154|  141|  331|  102|     0|  0.8494033|    820|    616|04 |  1|Rufous  |Male |2021-04-20 16:51:00 |2021-04-20 16:00:00 |\n|2021-04-20 |1706 |  200|  124|  406|  138|     0|  0.8925107|    820|    616|04 |  1|Rufous  |Male |2021-04-20 17:06:00 |2021-04-20 17:00:00 |\n|2021-04-20 |1718 |  634|  105|  814|   64|     0|  0.9755894|    820|    616|04 |  1|Rufous  |Male |2021-04-20 17:18:00 |2021-04-20 17:00:00 |\n|2021-04-20 |1914 |  164|  117|  368|  109|     0|  0.6146710|    820|    616|04 |  1|Rufous  |Male |2021-04-20 19:14:00 |2021-04-20 19:00:00 |\n|2021-04-20 |1925 |  196|  117|  408|  144|     0|  0.9455948|    820|    616|04 |  1|Rufous  |Male |2021-04-20 19:25:00 |2021-04-20 19:00:00 |\n|2021-04-20 |1942 |  177|  104|  378|   77|     0|  0.9968680|    820|    616|04 |  1|Rufous  |Male |2021-04-20 19:42:00 |2021-04-20 19:00:00 |\n:::\n:::\n\n# Preliminaries\n\n## Number of birds by species\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  group_by(Species, Sex) %>%\n  summarise('Number of ids' = n(), .groups = 'keep') %>%\n  kableExtra::kbl() %>%\n  kableExtra::kable_styling(full_width = F)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Species </th>\n   <th style=\"text-align:left;\"> Sex </th>\n   <th style=\"text-align:right;\"> Number of ids </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Annas </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 4127 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Annas </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 1792 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rufous </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 11720 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rufous </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 1081 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## Classifier confidence\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  gghistogram(x = 'confidence', fill = 'Species', color='Species', bins=100,\n              facet.by = 'Sex', scales = 'free_y', alpha=1, position='stack') +\n  labs(title = 'Prediction for females may be better calibrated',\n       subtitle = 'Higher proportion of low-confidence IDs for males vs females of both species', \n       x = 'Prediction confidence', y = 'Number of IDs') + \n  theme(legend.position = 'right') + \n  scale_fill_manual(values=c('chartreuse3', 'chocolate2')) + \n  scale_colour_manual(values=c('chartreuse3', 'chocolate2'))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## Number of birds after filtering on prediction confidence\n\nWe actually know from looking at the images that almost all the Rufouses after September 1st are false positives, so we'll remove these observations. Also, since we have very few IDs of the Annas in October, we will drop these from our data. Then, we'll filter to only retain the high-confidence (> 0.7 prediction probability) bird IDs \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird <- bird %>%\n  filter(!(Timestamp >= ymd('2021-09-01') & Species =='Rufous')) %>%\n  filter(Timestamp < ymd('2021-10-01')) %>%\n  filter(confidence > 0.7)\n\nbird %>%\n  group_by(Species, Sex) %>%\n  summarise('Number of IDs' = n(), .groups = 'keep') %>%\n  kableExtra::kbl() %>%\n  kableExtra::kable_styling(full_width = F)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Species </th>\n   <th style=\"text-align:left;\"> Sex </th>\n   <th style=\"text-align:right;\"> Number of IDs </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Annas </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 3070 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Annas </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 854 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rufous </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 9887 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rufous </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 667 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n\n\n# Migration patterns differ for Rufous and Anna\n\n::: {layout-ncol=2}\n![](anna_range.png)\n\n![](rufous_range.png)\n:::\n\n## Visit patterns over the summer\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- bird %>%\n  ggplot() + \n  aes(x = Date, fill = Species) + \n  geom_histogram(bins=100, position='dodge') + \n  labs(y='Number of IDs', x='', title='Rufous Migrates Away in July',\n       subtitle = 'Annas are present in BC year-round') + \n  scale_fill_manual(values=c('chartreuse3', 'chocolate2')) + \n  #facet_wrap('~Species') +\n  theme_pubr() \n\np2 <- bird %>% \n  ggplot() + \n  aes(x = Date, fill = Species, y=after_stat(count)) + \n  geom_density(bw=10, position='fill', show.legend = F, colour =NA) + \n  labs(y='Proportion of IDs') + \n  scale_fill_manual(values=c('chartreuse3', 'chocolate2'))+ \n  theme_pubr()\n\n\n(p1 / p2) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- bird %>% \n  filter(Species == 'Rufous') %>%\n  group_by(month(Timestamp), Sex) %>% \n  filter(n() > 5) %>%\n  ggplot() + \n  aes(x = Date, fill = Sex, y=after_stat(count)) + \n  geom_density(position='fill', colour =NA)  + \n  labs(y='Proportion of IDs') + \n  scale_fill_manual(values=c('chocolate1', 'chocolate4'))+ \n  theme_pubr() + labs(title='Rufous')\n\np2 <- bird %>% \n  filter(Species == 'Annas') %>%\n  group_by(month(Timestamp), Sex) %>% \n  filter(n() > 5) %>%\n  ggplot() + \n  aes(x = Date, fill = Sex, y=after_stat(count)) + \n  geom_density(position='fill', colour =NA) + \n  labs(y='Proportion of IDs') + \n  scale_fill_manual(values=c('chartreuse1', 'chartreuse4'))+ \n  theme_pubr() + labs(title='Anna')\n\n(p1) + (p2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n## Visiting Hours\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  mutate (Month = factor(month(Timestamp, label=T)), Hour= hour(Timestamp))%>%\n  filter(Species == 'Rufous') %>%\n  filter(Date < ymd('2021-08-01')) %>% \n  ggplot(aes(x=Hour, fill = Sex)) + \n  geom_bar(position = 'stack') + facet_wrap(\"~Month\", scales='free') +\n  scale_fill_manual(values=c('chocolate1', 'chocolate4')) + \n  labs(title='Rufous visit times vary by month', y = 'proportion') + \n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  mutate (Month = factor(month(Timestamp, label=T)), Hour= hour(Timestamp))%>%\n  filter(Species == 'Annas') %>%\n  ggplot(aes(x=Hour, fill = Sex)) + \n  geom_bar(position='stack') + facet_wrap(\"~Month\", scales='free') + \n  scale_fill_manual(values=c('chartreuse1', 'chartreuse4')) + \n  labs(title='Annas visit times vary by month', y = 'proportion') + \n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\nSince we see a big dip in visits in the middle of the day in both species in June, I wondered if the birds were avoiding the midday heat. This was an especially hot month for 2021, and there were lots of [forest fires](https://galiwatch.ca/posts/fires-2021)\n\n## Temperature preferences\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmerge(bird, weather, all.x=T) %>%\n  mutate (Month = factor(month(Date, label=T)), Hour= factor(hour(Timestamp)))%>%\n  group_by(Month, Hour, Species, Sex) %>%\n  summarise(n=n(), mean_temp = mean(`Temp C`, na.rm=T), .groups='drop') %>%\n  ggballoonplot(x = 'Hour', y = 'Month', size = 'n', fill='mean_temp', facet.by = '~Species+Sex')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n\n```{.r .cell-code}\np1 <- merge(bird, weather, all.x=T) %>%\n  filter(Species=='Rufous') %>%\n  mutate (Month = factor(month(Date, label=T)), Hour= hour(Timestamp))%>%\n  group_by(Month, Hour, Species) %>%\n  summarise(n=n(), temp = median(`Temp C`, na.rm=T), .groups='keep') %>%\n  ggplot(aes(x=temp, y = n))+ \n  geom_point(colour = 'chocolate2') + \n  geom_smooth(method='lm') +\n  facet_wrap(\"Month\", scales = \"free\")\n\np2 <- merge(bird, weather, all.x=T) %>%\n  filter(Species=='Annas') %>%\n  mutate (Month = factor(month(Date, label=T)), Hour= hour(Timestamp))%>%\n  group_by(Month, Hour, Species) %>%\n  summarise(n=n(), temp = median(`Temp C`, na.rm=T), .groups='keep') %>%\n  ggplot(aes(x=temp, y = n))+ \n  geom_point(colour = 'chartreuse3') + \n  geom_smooth(method='lm') +\n  facet_wrap(\"Month\", scales = \"free\")\n\n(p1) + (p2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-2.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  group_by(Date, Month = factor(month(Timestamp, label=T)), Hour= hour(Timestamp), Species, Sex) %>%\n  summarise(n=n(), .groups='keep') %>%\n  group_by(Month, Hour, Species, Sex,.groups='keep') %>%\n  summarize(mean_n = mean(n)) %>%\n  ggplot(aes(x=Hour, y = mean_n, colour = Month)) + \n  geom_point() + geom_line() + \n  facet_grid(rows = vars(Species), cols = vars(Sex), scales = 'free')+ \n  labs(y='average number of IDs per day')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  mutate(Hour = hour(Timestamp), Month = factor(month(Timestamp, label=T))) %>%\n  group_by(Month, Hour, Species, Sex) %>%\n  summarise(n=n()) %>%\n  ggplot(aes(x = Hour, y = Month, fill=Month, color =Month)) +\n  ggridges::geom_density_ridges(alpha= 0.2) + \n  facet_grid(rows = vars(Species), cols = vars(Sex))\n\n\nbird %>%\n  mutate(Hour = hour(Timestamp), Month = factor(month(Timestamp, label=T))) %>%\n  ggplot() +\n  aes(x=Hour, fill=Month) +\n  geom_bar() + \n  theme_pubr() + theme(legend.position = 'right') +\n  facet_wrap('~Species', scale='free') +\n  labs(x = 'Hour of Day', y = 'Count', title = 'Daylight changes over the months!')\n```\n:::\n\n\n# Distribution of sitting spots\n\nWe can plot the location of where each bird sits, with the proxy that a birds' feet will be at the center bottom of its bounding box. The birds appear to mostly sit in a circle, around the rim of the feeder. This makes sense, as it gives the best access to the sugar water.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% \n  mutate(xmid = (xmax+xmin)/2,ymid = (ymax+ymin)/2) %>%\n  ggscatter(x='xmid', y = 'ymid', alpha=0.5)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n\nHowever, it looks like there are 3 distinct positions that the feeder was in over the summer. We'll try to do batch correction for this, by assigning a batch number to each position, and subtract the average from the x and y direction. I think we can reasonably split the changes in position (the batches) simply by the date. This is easy to see in the ymid variable - the feeder moves twice around May 8th, and back down half way through the day on June 13th. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% \n  mutate(ymid = (ymax+ymin)/2, Month = month(Date, label=T)) %>%\n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid))+ \n  geom_jitter(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'Feeder Moves Up in May, Down in June')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n\nLets split these into batches for correction. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird$batch <- 1\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-08 00:00:00'),2,bird$batch)\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-11 00:00:00'),3,bird$batch)\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-06-13 12:21:00'),4,bird$batch)                  \nbird$batch <- factor(bird$batch)\n```\n:::\n\n\nWe can check it went as expected by recolouring the previous plot by batch\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>% \n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ \n  geom_point(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'We can Infer Position Batches Based on When the Feeder Moves',\n       colour = 'Batch')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\nNow we're ready to correct! We'll transform all the x- and y- values by subtracting the average of each batch. This will yield a new positioning relative to the middle of the feeder; we can no longer interpret this as the pixel index in the image. \n\n::: {.cell}\n\n```{.r .cell-code}\nbird_c <- bird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  group_by(batch) %>%\n  mutate(across(c(xmin, xmax, ymin, ymax), ~ .x-mean(.x)) ) %>%\n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2)\n\n\nbird_c %>% \n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ \n  geom_point(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'Batch corrected for average position',\n       colour = 'Batch')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-36-1.png){width=672}\n:::\n:::\n\n\nWe can see that the correction didn't completely fix things - our points are still offset by batch!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_c %>%\n  ggscatter(x='xmid', y = 'ymid', alpha=0.1, color = 'batch') + \n  labs(title = 'Batches don\\'t perfectly overlap', fill = 'Batch') \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n\n\nIt's a little hard to see in the scatter plot, but when we plot the density of points, it becomes apparent that we should be correcting for the perspective 'stretch' that happens when the feeder is in a different postion in the image. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_c %>%\n  ggplot(aes(x=xmid, y=ymid) ) +\n  stat_density_2d(aes(fill=batch), geom = \"polygon\", alpha=0.2) + \n  theme_pubr() + \n  labs(title = 'Density doesn\\'t match after position correction',\n       subtitle = 'We still need to correct for perspective scaling', fill = 'Batch')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-40-1.png){width=672}\n:::\n:::\n\n\nThe position correction didn't work perfectly, because there is some perspective disortion in the images. In theory, we could potentially calculate the effect of perspective, but we'd probably need to know things like how far away the feeder is from the camera, etc. For our purposes, it's probably acceptable to just add a scaling factor to the x- and y- directions and leave it at that. We could try to use QQ matching, or something like gradient descent to minimize the distance between our batch distributions. Instead, I'm just going to eyeball it. \n\nI picked a scaling coefficient for each batch (using batch 4 as my reference because it's the largest) by trial and error.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# x direction\np1 <- bird_c %>% \n  ggplot(aes(x=Timestamp, y = xmid, color=batch))+ \n  geom_jitter(alpha = 0.5, show.legend = F) + \n  theme_pubr() + \n  labs(title = 'No Scaling Correction')\n\np2 <- bird_c %>% \n  mutate(xmid = ifelse(batch==1, xmid*1.2, xmid)) %>% \n  mutate(xmid = ifelse(batch==2, xmid*1.5, xmid)) %>% \n  mutate(xmid = ifelse(batch==3, xmid*1.5, xmid)) %>% \n  ggplot(aes(x=Timestamp, y = xmid, color=batch))+ \n  geom_jitter(alpha = 0.5, show.legend = F) + \n  theme_pubr() + \n  labs(title = 'With Scaling Correction')\n\n# y direction\np3 <- bird_c %>%\n  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ \n  geom_jitter(alpha = 0.5, show.legend = F) + \n  theme_pubr() \n\n\np4 <- bird_c %>%\n  mutate(ymid = ifelse(batch==1, ymid*1.3, ymid)) %>%\n  mutate(ymid = ifelse(batch==2, ymid*1.4, ymid)) %>%\n  mutate(ymid = ifelse(batch==3, ymid*1.4,  ymid)) %>%\n  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ \n  geom_jitter(alpha = 0.5, show.legend = F) + \n  theme_pubr()\n\n\n(p1 | p2) / (p3 | p4)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-42-1.png){width=672}\n:::\n:::\n\n\nThis isn't an ideal approach, and if we dig into the different distributions of xmin/xman and ymin/ymax, we can see that the assumptions we made based on the xmid/ymid values don't really extend to the min/max values. In a future version of this analysis, we could use the detection information for feeder location and shape, but for now we can proceed with this eyeballed version.\n\nThe batch lineup looks a lot better for both the scatterplot, and densities in any case! \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_c <- bird_c %>% \n  mutate(xmin = ifelse(batch==1, xmin*1.2, xmin)) %>% \n  mutate(xmin = ifelse(batch==2, xmin*1.5, xmin)) %>% \n  mutate(xmin = ifelse(batch==3, xmin*1.5, xmin)) %>% \n  mutate(ymin = ifelse(batch==1, ymin*1.3, ymin)) %>%\n  mutate(ymin = ifelse(batch==2, ymin*1.4, ymin)) %>%\n  mutate(ymin = ifelse(batch==3, ymin*1.4, ymin)) %>% \n  \n  mutate(xmax = ifelse(batch==1, xmax*1.2, xmax)) %>% \n  mutate(xmax = ifelse(batch==2, xmax*1.5, xmax)) %>% \n  mutate(xmax = ifelse(batch==3, xmax*1.5, xmax)) %>% \n  mutate(ymax = ifelse(batch==1, ymax*1.3, ymax)) %>%\n  mutate(ymax = ifelse(batch==2, ymax*1.4, ymax)) %>%\n  mutate(ymax = ifelse(batch==3, ymax*1.4, ymax)) %>%\n  \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2)\n\np1 <- bird_c %>%\n  ggscatter(x='xmid', y = 'ymid', alpha=0.2, color='batch')\n  \n\np2 <- bird_c %>%ggplot(aes(x=xmid, y=ymid, fill=batch)) + \n  stat_density_2d(geom = \"polygon\", alpha=0.2) + \n  theme_pubr()\n\n(p1 | p2) + plot_annotation(title = 'Batch corrected bird location')\n```\n:::\n\nThe gap in the middle comes from the water column - we can't detect birds sitting behind it!\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimg <- jpeg::readJPEG('feeder.jpg')\n\nbird_c %>%\n  ggplot(aes(x=xmid, y = ymid)) + \n  ylim(-80,400) + \n  background_image(img) + \n  geom_point()\n```\n:::\n\n\n\n### Bird size! \n\nand sizes of the birds in our images, we have to \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird <- bird %>% \n  mutate(\n         xmid = (xmax+xmin)/2, \n         ymid = (ymax+ymin)/2,\n         Width = xmax - xmin, \n         Height = ymax - ymin\n  )\n\n\nbird %>%mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  ggscatter(x='Date', y='ymid')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# \n# how to make circle plot: pick center of box, plot x/y\n# most interested in feet: on the left - feet are on the left. \n# if you're on the right, your feet are on the right. Could probably pick the center\n\n# change female -> female + immature male\n\nbird %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot() + \n  aes(x=xmid, y = Width, xmax, colour = Sex) +\n  geom_point(alpha = 0.5) + \n  facet_wrap(~Species) +\n  labs(title = 'Birds are wider on the sides of the feeder (profile view?)')\n\nbird_c %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot(alpha = 0.5) + \n  aes(x=ymid, y = Height, xmax, colour = Sex) +\n  geom_point() + \n  facet_wrap(~Species) +\n  labs(title = 'Birds are taller near the top of the image')\n\nbird_c %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot(alpha = 0.5) + \n  aes(x=xmid, y = Height, xmax, colour = Sex) +\n  geom_point() + \n  facet_wrap(~Species) +\n  labs(title = 'Annas are taller (and don\\'t get captured sitting in the horizontal middle?)')\n\nbird_c %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot(alpha = 0.5) + \n  aes(x=ymid, y = Width, xmax, colour = Sex) +\n  geom_point() + \n  facet_wrap(~Species) +\n  labs(title = 'Widest Rufous are in the (vertical) middle, widest Anna are near the top')\n\nbird_c %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot(alpha = 0.5) + \n  aes(x=xmid, y = ymid, xmax, colour = Sex) +\n  geom_point() + \n  facet_wrap(~Species) +\n  labs(title = 'Birds mostly sit on the feeder. There may be one male anna who prefers the deck rail :)')\n\nbird_c %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot(alpha = 0.5) + \n  aes(x=Width, y = Height, xmax, colour = Sex) +\n  geom_point() + \n  facet_wrap(~Species) +\n  labs(title = 'Wider birds are generally taller birds')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# number of birds per day \n\nbird_c %>% \n  group_by(Date, Species, Sex) %>%\n  summarise(n=n(), `Temp C` = max(`Temp C`), .groups='keep') %>%\n  ggplot() + \n  aes(x = Date, y = n, fill = Sex) + \n  geom_bar(stat = 'identity') +\n  facet_wrap(~Species) + \n  labs(y = 'Number of bird visits', title = 'Most Rufous visit in Summer, Female Annas visit in Fall,\\nMale Annas are year-round')\n\n# Not really what happened\n\nbird_c %>% \n  group_by(Date, Species, Sex) %>%\n  summarise(n=n(), `Temp C` = max(`Temp C`), .groups='keep') %>%\n  ggplot() + \n  aes(x = n, y = `Temp C`, colour = Sex) + \n  geom_point() + \n  geom_smooth(method = 'lm', formula = 'y~x', se = F, linetype='dashed') +\n  facet_wrap(~Species, scales = 'free_x') + \n  labs(x = 'Number of bird visits', title = 'Everyone except Female Annas prefers lower temperatures')\n```\n:::\n\n\n# Number of birds in an image for each class\n\nRufous males can be very territorial. We'd like to know whether we can see evidence of the \"chasing away\" behaviour.\n\nIf this is the case, then the disappearance of the male rufous should lead to an increase in the *absolute number* of Annas who come (but might not affect the number of female rufous.  And the later disappearance of the female rufous should also lead to an increase in the number of Annas.\n\nBecause it's hard to see this on a minute-to-minute basis, we'll summarize the number of Anna visits by day.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# total number of birds per day\nbird %>%\n  filter(Species=='Annas') %>%\n  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%\n  group_by(Date,`Rufous Males present`, Sex, .groups='keep') %>%\n  summarize(n=n()) %>%\n  ggplot(aes(x=`Rufous Males present`, y = n)) +\n  geom_rect(aes(fill = Sex),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, show.legend = F) + \n  geom_boxplot() + \n  facet_wrap(\"~Sex\") + \n  stat_compare_means(method = \"t.test\", label.y = 180, label.x = 1.3) + \n  geom_bracket(xmin = 1, xmax = 2, label = '', y.position = c(170)) +\n  theme_pubr() + \n  labs(title='Rufous Males are better at scaring off Female Annas than Male Annas') + \n  scale_fill_manual(values = c('chartreuse1', 'chartreuse4'))\n\n# average number of birds per image per day\nbird %>%\n  filter(Species=='Annas') %>%\n  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%\n  \n  group_by(Date,`Rufous Males present`, Timestamp, Sex, .groups='keep') %>%\n  summarize(n=n()) %>%\n  group_by(Date, `Rufous Males present`, Sex) %>%\n  summarize(n=mean(n), .groups = 'keep') %>%\n  \n  ggplot(aes(x=`Rufous Males present`, y = n)) +\n  geom_rect(aes(fill = Sex),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, show.legend = F) + \n  geom_boxplot() + \n  facet_wrap(\"~Sex\") + \n  stat_compare_means(method = \"t.test\", label.y = 1.41, label.x = 1.3) + \n  geom_bracket(xmin = 1, xmax = 2, label = '', y.position = 1.4) +\n  theme_pubr() + \n  labs(title='Rufous Males are better at scaring off Female Annas than Male Annas') + \n  scale_fill_manual(values = c('chartreuse1', 'chartreuse4'))\n\n\nbird %>%\n  group_by(Date, Timestamp, Species, .groups='keep') %>%\n  summarize(n=n()) %>%\n  #group_by(Date, Species) %>%\n  #summarize(n=mean(n), .groups = 'keep') %>%\n  ggplot(aes(x=factor(Date), y = n, colour=Species)) + \n  geom_point()+\n  geom_smooth(aes(colour =Species), method='lm', formula='y~poly(x,4)')\n\nbird %>%\n  #filter(Species=='Annas') %>%\n  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%\n  group_by(Date, `Rufous Males present`, Species, Sex) %>%\n  summarize(n=n()) %>%\n  ggplot(aes(x=`Rufous Males present`, y = n)) +\n  geom_boxplot() +\n  facet_grid(rows =vars(Species), cols = vars(Sex), scales='free')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird  %>%group_by(Timestamp, Species, Sex) %>% summarize(n=n()) %>% ggplot() +aes(x = Timestamp, y=n, color = Species, fill=Species) + geom_bar(stat='identity') + facet_wrap('~Sex') +scale_color_manual(values=c('chartreuse2', 'chocolate3'))+scale_fill_manual(values=c('chartreuse2', 'chocolate3'))\n```\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\r\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}