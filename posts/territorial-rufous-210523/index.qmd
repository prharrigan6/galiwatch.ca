---
title: Ter
draft: true
date: 2023-03-17
author: Cait Harrigan
image: thumbnail.jpg
toc: true
categories:
  - birds
  - code
  - data analysis
  - deep-dive
format:
  html:
      code-fold: true
---

Reading time: `r ifelse(file.size("index.qmd")/2000 < 1, '<1 minute', paste0(round(file.size("index.qmd")/2000), ' minutes'))`


![](species_locations.gif)
# Continuation of hummer-watch data analysis!

```{r, message=F, warning=F}
library(tidyverse)
library(lubridate)
library(patchwork)
library(ggpubr)

#weather <- read_csv('https://github.com/teaswamp-creations/galiwatch.ca/raw/quarto-website/posts/hummer-watch/WS_hours.csv') %>%
weather <- read_csv('WS_hours.csv') %>%
  # retain only non-duplicates
  distinct() %>%
  # Clean up timestamps, convert to celsius
  mutate(Date = ymd(Date), 
         MergeTime = ymd_hms(paste(Date, Time)),
         `Temp C` = (`Outdoor Temperature F`-32) * (5/9)
         )

# classifier labels
classes = c('Rufous_Male', 'Annas_Male', 'Person', 'Annas_Female', 'Rufous_Female')

# read in bird detection data, and do some basic data cleaning
#bird <- read_csv('https://raw.githubusercontent.com/teaswamp-creations/galiwatch.ca/quarto-website/posts/hummer-watch/2021_reprocessed_hummers_combo_2023.csv') %>% 
bird <- read_csv('2021_reprocessed_hummers_combo_2023.csv') %>%
  # lookup labels
  mutate(class = classes[label + 1]) %>%
  # put columns into tidy format
  separate(class, into=c('Species', 'Sex'), sep='_') %>%
  separate(image, into=c('Date', 'image'), sep="_", remove = F) %>%
  separate(image, into=c('hhmm'), sep=".jpg", extra = 'drop') %>%
  # clean up timestamps
  mutate(Timestamp = ymd_hm(paste(Date, hhmm))) %>%
  # remove people
  filter(label != 2) %>%
  # change column types, correct for variable image size
  mutate(Date=ymd(Date),
         Month=factor(month(Date, label = T)),
         Hour=hour(Timestamp),
         Species = ordered(Species),
         Sex = factor(Sex),
         ymin2 = ymin,
         ymin = (y_size - ymax),
         ymax = (y_size - ymin2),
         MergeTime = floor_date(Timestamp, 'hour')
  ) %>%
  # correct for variable image size
  mutate(
    ymin = ifelse(y_size == 420, ymin * (616/420), ymin),
    ymax = ifelse(y_size == 420, ymax * (616/420), ymax),
    xmin = ifelse(y_size == 420, xmin * (616/420), xmin),
    xmax = ifelse(y_size == 420, xmax * (616/420), xmax),
  )


bird$batch <- 1
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-08 00:00:00'),2,bird$batch)
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-11 00:00:00'),3,bird$batch)
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-06-13 12:21:00'),4,bird$batch)                  
bird$batch <- factor(bird$batch)

bird_c <- bird %>% 
  mutate(Month = month(Date, label=T)) %>%
  group_by(batch) %>%
  mutate(across(c(xmin, xmax, ymin, ymax), ~ .x-mean(.x)) ) %>%
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2)

```


# Number of birds in an image for each class

Rufous males can be very territorial. We'd like to know whether we can see evidence of the "chasing away" behaviour.

If this is the case, then the disappearance of the male rufous should lead to an increase in the *absolute number* of Annas who come (but might not affect the number of female rufous.  And the later disappearance of the female rufous should also lead to an increase in the number of Annas.

Because it's hard to see this on a minute-to-minute basis, we'll summarize the number of Anna visits by day.


```{r, eval=F}

# number of birds per day 

bird_c %>% 
  group_by(Date, Species, Sex) %>%
  summarise(n=n(), `Temp C` = max(`Temp C`), .groups='keep') %>%
  ggplot() + 
  aes(x = Date, y = n, fill = Sex) + 
  geom_bar(stat = 'identity') +
  facet_wrap(~Species) + 
  labs(y = 'Number of bird visits', title = 'Most Rufous visit in Summer, Female Annas visit in Fall,\nMale Annas are year-round')

# Not really what happened

bird_c %>% 
  group_by(Date, Species, Sex) %>%
  summarise(n=n(), `Temp C` = max(`Temp C`), .groups='keep') %>%
  ggplot() + 
  aes(x = n, y = `Temp C`, colour = Sex) + 
  geom_point() + 
  geom_smooth(method = 'lm', formula = 'y~x', se = F, linetype='dashed') +
  facet_wrap(~Species, scales = 'free_x') + 
  labs(x = 'Number of bird visits', title = 'Everyone except Female Annas prefers lower temperatures')



```

```{r, eval=T}

# total number of birds per day
bird %>%
  filter(Species=='Annas') %>%
  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%
  group_by(Date,`Rufous Males present`, Sex, .groups='keep') %>%
  summarize(n=n()) %>%
  ggplot(aes(x=`Rufous Males present`, y = n)) +
  geom_rect(aes(fill = Sex),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, show.legend = F) + 
  geom_boxplot() + 
  facet_wrap("~Sex") + 
  stat_compare_means(method = "t.test", label.y = 180, label.x = 1.3) + 
  geom_bracket(xmin = 1, xmax = 2, label = '', y.position = c(170)) +
  theme_pubr() + 
  labs(title='Rufous Males are better at scaring off Female Annas than Male Annas') + 
  scale_fill_manual(values = c('chartreuse1', 'chartreuse4'))

# average number of birds per image per day
bird %>%
  filter(Species=='Annas') %>%
  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%
  
  group_by(Date,`Rufous Males present`, Timestamp, Sex, .groups='keep') %>%
  summarize(n=n()) %>%
  group_by(Date, `Rufous Males present`, Sex) %>%
  summarize(n=mean(n), .groups = 'keep') %>%
  
  ggplot(aes(x=`Rufous Males present`, y = n)) +
  geom_rect(aes(fill = Sex),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, show.legend = F) + 
  geom_boxplot() + 
  facet_wrap("~Sex") + 
  stat_compare_means(method = "t.test", label.y = 1.41, label.x = 1.3) + 
  geom_bracket(xmin = 1, xmax = 2, label = '', y.position = 1.4) +
  theme_pubr() + 
  labs(title='Rufous Males are better at scaring off Female Annas than Male Annas') + 
  scale_fill_manual(values = c('chartreuse1', 'chartreuse4'))


bird %>%
  group_by(Date, Timestamp, Species, .groups='keep') %>%
  summarize(n=n()) %>%
  #group_by(Date, Species) %>%
  #summarize(n=mean(n), .groups = 'keep') %>%
  ggplot(aes(x=factor(Date), y = n, colour=Species)) + 
  geom_point()+
  geom_smooth(aes(colour =Species), method='lm', formula='y~poly(x,4)')

bird %>%
  #filter(Species=='Annas') %>%
  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%
  group_by(Date, `Rufous Males present`, Species, Sex) %>%
  summarize(n=n()) %>%
  ggplot(aes(x=`Rufous Males present`, y = n)) +
  geom_boxplot() +
  facet_grid(rows =vars(Species), cols = vars(Sex), scales='free')



```

```{r, eval=T}
bird  %>%group_by(Timestamp, Species, Sex) %>% summarize(n=n()) %>% ggplot() +aes(x = Timestamp, y=n, color = Species, fill=Species) + geom_bar(stat='identity') + facet_wrap('~Sex') +scale_color_manual(values=c('chartreuse2', 'chocolate3'))+scale_fill_manual(values=c('chartreuse2', 'chocolate3'))
```
```{r eval=T}
bird %>%
  group_by(Date, Month = factor(month(Timestamp, label=T)), Hour= hour(Timestamp), Species, Sex) %>%
  summarise(n=n(), .groups='keep') %>%
  group_by(Month, Hour, Species, Sex,.groups='keep') %>%
  summarize(mean_n = mean(n)) %>%
  ggplot(aes(x=Hour, y = mean_n, colour = Month)) + 
  geom_point() + geom_line() + 
  facet_grid(rows = vars(Species), cols = vars(Sex), scales = 'free')+ 
  labs(y='average number of IDs per day')

```

```{r eval=T}
bird %>%
  mutate(Hour = hour(Timestamp), Month = factor(month(Timestamp, label=T))) %>%
  group_by(Month, Hour, Species, Sex) %>%
  summarise(n=n()) %>%
  ggplot(aes(x = Hour, y = Month, fill=Month, color =Month)) +
  ggridges::geom_density_ridges(alpha= 0.2) + 
  facet_grid(rows = vars(Species), cols = vars(Sex))


bird %>%
  mutate(Hour = hour(Timestamp), Month = factor(month(Timestamp, label=T))) %>%
  ggplot() +
  aes(x=Hour, fill=Month) +
  geom_bar() + 
  theme_pubr() + theme(legend.position = 'right') +
  facet_wrap('~Species', scale='free') +
  labs(x = 'Hour of Day', y = 'Count', title = 'Daylight changes over the months!')
```

