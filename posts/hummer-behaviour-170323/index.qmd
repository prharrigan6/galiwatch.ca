---
title: Tracking hummingbirds at the feeder
draft: true
date: 2023-03-17
author: Cait Harrigan
image: thumbnail.jpg
toc: true
categories:
  - birds
  - code
  - data analysis
  - deep-dive
    
format:
  html:
      code-fold: true

---

Reading time: `r ifelse(file.size("index.qmd")/2000 < 1, '<1 minute', paste0(round(file.size("index.qmd")/2000), ' minutes'))`

# Background

There are two species of hummingbirds found near Galiano: the green [Anna's Hummingbird ](https://en.wikipedia.org/wiki/Anna%27s_hummingbird) and the orange [Rufous Hummingbird](https://en.wikipedia.org/wiki/Rufous_hummingbird). ID images from (All About Birds)[https://www.allaboutbirds.org/]. 


::: {layout-ncol=2}
![](anna_id.png)

![](rufous_id.png)
:::



We set up a camera to capture these feathery fellows visiting our hummingbird feeder.

![A Female Anna's (left) and Male Rufus (right) at our feeder](ar_2.jpg)

We trained a classifier to detect who's who....

::: {layout-ncol=3}
![](2021-06-10_1201_hbird.jpg)

![](2021-09-06_1243_hbird.jpg)

![](2021-09-06_1930_hbird.jpg)
:::

And we're even able to keep track of when the feeder needs a refill! 

<center>
![](water_level.gif){width=400}
</center>
<br>

But we'll save the details for a future blog post `r emo::ji('smile')`

For now, lets dive in to some of the data we've collected!


# Setup

We'll read in our data: weather from our weather station, and the classifier output as well as bounding boxes of detected birds. 

```{r, message=F, warning=F}
library(tidyverse)
library(lubridate)
library(patchwork)
library(ggpubr)

#weather <- read_csv('https://github.com/teaswamp-creations/galiwatch.ca/raw/quarto-website/posts/hummer-watch/WS_hours.csv') %>%
weather <- read_csv('WS_hours.csv') %>%
  # retain only non-duplicates
  distinct() %>%
  # Clean up timestamps, convert to celsius
  mutate(Date = ymd(Date), 
         MergeTime = ymd_hms(paste(Date, Time)),
         `Temp C` = (`Outdoor Temperature F`-32) * (5/9)
         )

# classifier labels
classes = c('Rufous_Male', 'Annas_Male', 'Person', 'Annas_Female', 'Rufous_Female')

# read in bird detection data, and do some basic data cleaning
#bird <- read_csv('https://raw.githubusercontent.com/teaswamp-creations/galiwatch.ca/quarto-website/posts/hummer-watch/2021_reprocessed_hummers_combo_2023.csv') %>% 
bird <- read_csv('2021_reprocessed_hummers_combo_2023.csv') %>%
  # lookup labels
  mutate(class = classes[label + 1]) %>%
  # put columns into tidy format
  separate(class, into=c('Species', 'Sex'), sep='_') %>%
  separate(image, into=c('Date', 'image'), sep="_", remove = F) %>%
  separate(image, into=c('hhmm'), sep=".jpg", extra = 'drop') %>%
  # clean up timestamps
  mutate(Timestamp = ymd_hm(paste(Date, hhmm))) %>%
  # remove people
  filter(label != 2) %>%
  # change column types, correct for variable image size
  mutate(Date=ymd(Date),
         Month=factor(month(Date, label = T)),
         Hour=hour(Timestamp),
         Species = ordered(Species),
         Sex = factor(Sex),
         ymin2 = ymin,
         ymin = (y_size - ymax),
         ymax = (y_size - ymin2),
         MergeTime = floor_date(Timestamp, 'hour')
  ) %>%
  # correct for variable image size
  mutate(
    ymin = ifelse(y_size == 420, ymin * (616/420), ymin),
    ymax = ifelse(y_size == 420, ymax * (616/420), ymax),
    xmin = ifelse(y_size == 420, xmin * (616/420), xmin),
    xmax = ifelse(y_size == 420, xmax * (616/420), xmax),
  ) 
```

Lets take a peek at the data. The air quality measures show the concentration of particulates at three different size thresholds (in micrometers), as well as the outdoor air temperature recorded from April - December 2021.

```{r, echo = T}
knitr::kable(head(weather))
```

The bird detector gives us the the bounding box of each bird in an image, and the predicted sex and species of the bird. Note that because it's hard to distinguish female birds from the immature males, there are likely some which are misclassified. 

```{r, echo = T}
knitr::kable(head(bird))
```

# Preliminaries

## Number of birds by species

Our bird detector ID'd lots of visitors! Each ID represents a bird captured in an image, and not necessarily an individual. The images are captured once every minute, so if for example a single bird sat at the feeder for two minutes in a row, it would get counted twice. There may be multiple birds in a single image. 

```{r}
bird %>%
  group_by(Species, Sex) %>%
  summarise('Number of ids' = n(), .groups = 'keep') %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling(full_width = F)
```


## Classifier confidence

Each bird ID is made by picking the the most likely label, based on the prediction probability. Sometimes, the classifier isn't as confident as others. For example, it may be harder to identify a bird that is facing away from the camera. We can plot the confidences, and see which birds are the hardest to label.


```{r, warning=F}
bird %>%
  gghistogram(x = 'confidence', fill = 'Species', color='Species', bins=100,
              facet.by = 'Sex', scales = 'free_y', alpha=1, position='stack') +
  labs(title = 'Prediction for females may be better calibrated',
       subtitle = 'Higher proportion of low-confidence IDs for males vs females of both species', 
       x = 'Prediction confidence', y = 'Number of IDs') + 
  theme(legend.position = 'right') + 
  scale_fill_manual(values=c('chartreuse3', 'chocolate2')) + 
  scale_colour_manual(values=c('chartreuse3', 'chocolate2'))
```

It looks like for both species, Male birds are slightly harder to identify with high confidence than Female. This might be explained by the fact that there are many more Female examples than Male in our data. 

There is almost certainly some mistakes in our classifier, including false positives (non-birds labeled as birds) and false negatives (birds mistakenly labeled) 

To help make sure we're only considering high-quality calls, we'll pike a confidence threshold and only analyse the IDs above that level. 

## Number of birds after filtering

We manually looked at the images, and found that that almost all the Rufouses after September 1st are false positives, so we'll remove these observations. Also, since we have very few IDs in October, we will drop this month from our data. Then, we'll filter to only retain the high-confidence (> 0.7 prediction probability) bird IDs 

```{r}
bird <- bird %>%
  filter(!(Timestamp >= ymd('2021-09-01') & Species =='Rufous')) %>%
  filter(Timestamp < ymd('2021-10-01')) %>%
  filter(confidence > 0.7)
```

Lastly, we'll sanity check the bounding boxes for their size.

```{r}
bird <- bird %>%
  mutate(
    Height = ymax-ymin, 
    Width = xmax-xmin, 
    Area = Height * Width
    
  )

bird %>% 
  gghistogram(x="Area", bins = 100) + 
  labs(title = 'There are some very small and some very large bounding boxes.',
       subtitle = "Note also relative raity of areas at 25,000 and 50,000 pixels", y = 'Count')
```

This distribution more or less makes sense, we see some very small bounding boxes which may be mis-calls or birds who are only half in the image. There are also some cases where a bird is partially obscured because it's sitting behind the feeder. There are some very large bounding boxes also. I'm not sure exactly whether these are real, giant humming birds, or some kind of artifact. We'll drop the smallest and largest 1% of bounding boxes just in case. 

```{r}
bird <- bird %>% 
  filter(Area > quantile(bird$Area, 0.01) & Area < quantile(bird$Area, 0.99)) 
```

Note that because of the camera perspective, bounding box area will be affected by not only the bird size, but also its closeness to the camera. 

The dips we see around 25,000 and 50,000 bounding box size are surprizing, this means that there are certain height/width combinations that are not being picked up very frequently. This may indicate that there are certain positions on the feeder at which we can't effectively identify birds. 

We see this even more clearly by plotting bird height against width. 

```{r}
bird %>%
  ggscatter(x = "Width", y = "Height", add = "reg.line", alpha = 0.2, 
            add.params = list(color = "black", fill = "lightgray")) +
  stat_cor(label.x = 25, label.y = 400) +
  stat_regline_equation(label.x = 25, label.y = 380) + 
  labs(title = 'Some height/width combinations are missing')
```

There's some height/widths with no birds observed at them! To check whether this may be related to out classifier's ability to call these birds, we can colour this plot by the confidence level (recall: we already filtered the data such that all ID's have confidence > 0.7). 

```{r message=F, warning=F}
bird %>%
  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%
  ggscatter(x = "Width", y = "Height", add = "reg.line", alpha = 0.4, color= 'confidence_lvl',
            add.params = list(color = "black", fill = "lightgray", linetype='dashed')) +
  stat_cor(label.x = 25, label.y = 400) +
  stat_regline_equation(label.x = 25, label.y = 380) + 
  labs(title = 'Missing height/widths may be caused to hard-to call birds',
       colour = 'Confidence Level') 

```

We can see that at least some of these "holes" seem to be associated with lower-confidence IDs, which is consistent with the hypothesis that they're indicative of missing IDs from hard-to-call birds. 


Here's how many IDs we're left with after that data cleaning: 

```{r}
bird %>%
  group_by(Species, Sex) %>%
  summarise('Number of IDs' = n(), .groups = 'keep') %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling(full_width = F)
```


# Migration patterns differ for Rufous and Anna

The Anna and Rufous hummingbirds have two quite distinct migration patterns: Annas are year-round visitors to our feeder in BC, while the Rufouses tend to leave for Mexico about half way through the summer.

::: {layout-ncol=2}
![](anna_range.png)

![](rufous_range.png)

Adapted from Wikipedia
:::

## Visit patterns over the summer

```{r}
p1 <- bird %>%
  ggplot() + 
  aes(x = Date, fill = Species) + 
  geom_histogram(bins=100, position='dodge') + 
  labs(y='Number of IDs', x='', title='Rufous Migrates Away in July',
       subtitle = 'Annas are present in BC year-round') + 
  scale_fill_manual(values=c('chartreuse3', 'chocolate2')) + 
  #facet_wrap('~Species') +
  theme_pubr() 

p2 <- bird %>% 
  ggplot() + 
  aes(x = Date, fill = Species, y=after_stat(count)) + 
  geom_density(bw=10, position='fill', show.legend = F, colour =NA) + 
  labs(y='Proportion of IDs') + 
  scale_fill_manual(values=c('chartreuse3', 'chocolate2'))+ 
  theme_pubr()


(p1 / p2) 

```
The Male Rufous leave earlier than the Female: they're almost all gone by July. The latest dates we have for *manually confirmed* Rufous visits are: 
 
* Male: July 5th 2021
* Female : July 31st 2021

```{r}
p1 <- bird %>% 
  filter(Species == 'Rufous') %>%
  group_by(Month, Sex) %>% 
  filter(n() > 5) %>%
  ggplot() + 
  aes(x = Month, fill = Sex, y=after_stat(count)) + 
  geom_bar(position='fill', colour =NA)  + 
  labs(y='Proportion of IDs') + 
  scale_fill_manual(values=c('chocolate1', 'chocolate4'))+ 
  theme_pubr() + labs(title='Rufous')

p2 <- bird %>% 
  filter(Species == 'Annas') %>%
  group_by(Month, Sex) %>% 
  filter(n() > 5) %>%
  ggplot() + 
  aes(x = Month, fill = Sex, y=after_stat(count)) + 
  geom_bar(position='fill', colour =NA) + 
  labs(y='Proportion of IDs') + 
  scale_fill_manual(values=c('chartreuse1', 'chartreuse4'))+ 
  theme_pubr() + labs(title='Anna')

(p1) + (p2)
```
The Annas on the other hand, seem to hover around 1:3 Male to Female ID ratio, with the dramatic exception of April. This may have to do with female nesting behaviours, but we don't know for sure. 

## Visiting Hours

We thought the hours of the day in which birds visit the feeder might give interesting insight into their behaviour. After poking around in te data, we found that visiting hours vary widely from month-to-month. In both species, we see a big dip in visits from 12-3pm in June. Our hypothesis is that this has to do with avoiding the sun or hottest temperatures in the middle of the day. June was an especially hot month for 2021, and there were lots of [forest fires](https://galiwatch.ca/posts/fires-2021). However, it's somewhat surprising to not also see this effect in July and August, which are generally similar to June in terms of weather. 

```{r}
bird %>%
  filter(Species == 'Rufous') %>%
  filter(Date < ymd('2021-08-01')) %>% 
  ggplot(aes(x=Hour, fill = Sex)) + 
  geom_bar(position = 'stack') + facet_wrap("~Month", scales='free_y') +
  scale_fill_manual(values=c('chocolate1', 'chocolate4')) + 
  labs(title='Rufous visit times vary by month', y = 'Number of IDs') + 
  theme_pubr()

```

```{r}

bird %>%
  filter(Species == 'Annas') %>%
  ggplot(aes(x=Hour, fill = Sex)) + 
  geom_bar(position='stack') + facet_wrap("~Month", scales='free_y') + 
  scale_fill_manual(values=c('chartreuse1', 'chartreuse4')) + 
  labs(title='Annas visit times vary by month', y = 'Number of IDs') + 
  theme_pubr()

```

## Temperature preferences

Based on the visiting hours plots, it seems like there may be a temperature effect in play, especially in June. To look into this, I made some linear regressions by month. There seemed to be some strong negative correlation in the hot months of June, July, August! 

Relationship between temperature and number of visits differs by month. 

```{r message=F, warning=F}

p1 <- merge(bird, weather, all.x=T) %>%
  filter(Species=='Rufous') %>%
  filter(Date < ymd('2021-08-01')) %>% 
  group_by(Month, Hour, Species) %>%
  summarise(n=n(), temp = median(`Temp C`, na.rm=T), .groups='keep') %>%
  ggplot(aes(x=temp, y = n))+ 
  geom_point(colour = 'chocolate2') + 
  geom_smooth(method='lm', colour = 'chocolate4') +
  labs(title='Rufous', x='Temperature (C)', y = 'Number of Visits')+
  facet_wrap("Month", nrow=2, scales = "free_y")+
  theme_pubr()


p2 <- merge(bird, weather, all.x=T) %>%
  filter(Species=='Annas') %>%
  group_by(Month, Hour, Species) %>%
  summarise(n=n(), temp = median(`Temp C`, na.rm=T), .groups='keep') %>%
  ggplot(aes(x=temp, y = n))+ 
  geom_point(colour = 'chartreuse3') + 
  geom_smooth(method='lm', colour = 'chartreuse4') +
  labs(title='Anna', x='Temperature (C)', y = 'Number of Visits')+
  facet_wrap("Month", scales = "free_y")+ 
  theme_pubr()

(p1) + (p2)


```
Both species seem to dislike temperatures above 20 degrees C. 

```{r warning=F, message=F}
#birds per hour above and below 20 degrees
zeros <- weather %>%
  filter(Date>=min(bird$Date) & Date <= max(bird$Date)) %>%
  mutate(Species = 'Rufous', Sex = 'Male', `Temp C`) %>%
  select(Date, Time, MergeTime, `Temp C`, Species, Sex) %>%
  complete(expand(bird,Species,Sex)) %>%
  filter(!is.na(Date)) %>%
  mutate(n = 0)

counts <- bird %>%
  group_by(MergeTime, Species, Sex) %>%
  summarize(n=n()) 

weather %>% 
  filter(c('MergeTime', `Temp C`))

merge(counts, weather, all=T) 

bind_rows(counts, zeros) %>% 
  # count birds per hour
  group_by(MergeTime, Species, Sex) %>%
  summarize(n=max(n), `Temp C` = max(`Temp C`, na.rm = T)) %>%
  mutate(temp_lvl = cut(`Temp C`, c(0, 10, 15, 20, 25, 40))) %>%
  # summarize birds per hour at different temps
  ggplot() +
  aes(x = temp_lvl, y=n) +
  geom_point()


```


```{r eval=F}
bird %>%
  group_by(Date, Month = factor(month(Timestamp, label=T)), Hour= hour(Timestamp), Species, Sex) %>%
  summarise(n=n(), .groups='keep') %>%
  group_by(Month, Hour, Species, Sex,.groups='keep') %>%
  summarize(mean_n = mean(n)) %>%
  ggplot(aes(x=Hour, y = mean_n, colour = Month)) + 
  geom_point() + geom_line() + 
  facet_grid(rows = vars(Species), cols = vars(Sex), scales = 'free')+ 
  labs(y='average number of IDs per day')

```

```{r eval=F}
bird %>%
  mutate(Hour = hour(Timestamp), Month = factor(month(Timestamp, label=T))) %>%
  group_by(Month, Hour, Species, Sex) %>%
  summarise(n=n()) %>%
  ggplot(aes(x = Hour, y = Month, fill=Month, color =Month)) +
  ggridges::geom_density_ridges(alpha= 0.2) + 
  facet_grid(rows = vars(Species), cols = vars(Sex))


bird %>%
  mutate(Hour = hour(Timestamp), Month = factor(month(Timestamp, label=T))) %>%
  ggplot() +
  aes(x=Hour, fill=Month) +
  geom_bar() + 
  theme_pubr() + theme(legend.position = 'right') +
  facet_wrap('~Species', scale='free') +
  labs(x = 'Hour of Day', y = 'Count', title = 'Daylight changes over the months!')
```

# Distribution of sitting spots

We can plot the location of where each bird sits, with the proxy that a birds' feet will be at the center bottom of its bounding box. The birds appear to mostly sit in a circle, around the rim of the feeder. This makes sense, as it gives the best access to the sugar water.

```{r}
bird %>% 
  mutate(xmid = (xmax+xmin)/2,ymid = (ymax+ymin)/2) %>%
  ggscatter(x='xmid', y = 'ymid', alpha=0.5)
```


However, it looks like there are 3 distinct positions that the feeder was in over the summer. We'll try to do batch correction for this, by assigning a batch number to each position, and subtract the average from the x and y direction. I think we can reasonably split the changes in position (the batches) simply by the date. This is easy to see in the ymid variable - the feeder moves twice around May 8th, and back down half way through the day on June 13th. 

```{r}
bird %>% 
  mutate(ymid = (ymax+ymin)/2, Month = month(Date, label=T)) %>%
  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%
  ggplot(aes(x=Timestamp, y = ymid))+ 
  geom_jitter(alpha = 0.5) + 
  facet_wrap("~Month", scales = 'free_x') + 
  theme_pubr() + 
  labs(title = 'Feeder Moves Up in May, Down in June')
```

Lets split these into batches for correction. 

```{r batching}
bird$batch <- 1
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-08 00:00:00'),2,bird$batch)
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-11 00:00:00'),3,bird$batch)
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-06-13 12:21:00'),4,bird$batch)                  
bird$batch <- factor(bird$batch)
```

We can check it went as expected by recolouring the previous plot by batch

```{r}
bird %>% 
  mutate(Month = month(Date, label=T)) %>%
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>% 
  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%
  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ 
  geom_point(alpha = 0.5) + 
  facet_wrap("~Month", scales = 'free_x') + 
  theme_pubr() + 
  labs(title = 'We can Infer Position Batches Based on When the Feeder Moves',
       colour = 'Batch')
```
Now we're ready to correct! We'll transform all the x- and y- values by subtracting the average of each batch. This will yield a new positioning relative to the middle of the feeder; we can no longer interpret this as the pixel index in the image. 
```{r}
bird_c <- bird %>% 
  mutate(Month = month(Date, label=T)) %>%
  group_by(batch) %>%
  mutate(across(c(xmin, xmax, ymin, ymax), ~ .x-mean(.x)) ) %>%
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2)


bird_c %>% 
  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%
  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ 
  geom_point(alpha = 0.5) + 
  facet_wrap("~Month", scales = 'free_x') + 
  theme_pubr() + 
  labs(title = 'Batch corrected for average position',
       colour = 'Batch')
```

We can see that the correction didn't completely fix things - our points are still offset by batch!

```{r}
bird_c %>%
  ggscatter(x='xmid', y = 'ymid', alpha=0.1, color = 'batch') + 
  labs(title = 'Batches don\'t perfectly overlap', fill = 'Batch') 

```

It's a little hard to see in the scatter plot, but when we plot the density of points, it becomes apparent that we should be correcting for the perspective 'stretch' that happens when the feeder is in a different postion in the image. 

```{r}
bird_c %>%
  ggplot(aes(x=xmid, y=ymid) ) +
  stat_density_2d(aes(fill=batch), geom = "polygon", alpha=0.2) + 
  theme_pubr() + 
  labs(title = 'Density doesn\'t match after position correction',
       subtitle = 'We still need to correct for perspective scaling', fill = 'Batch')


```

The position correction didn't work perfectly, because there is some perspective disortion in the images. In theory, we could potentially calculate the effect of perspective, but we'd probably need to know things like how far away the feeder is from the camera, etc. For our purposes, it's probably acceptable to just add a scaling factor to the x- and y- directions and leave it at that. We could try to use QQ matching, or something like gradient descent to minimize the distance between our batch distributions. Instead, I'm just going to eyeball it. 

I picked a scaling coefficient for each batch (using batch 4 as my reference because it's the largest) by trial and error.

```{r}
# x direction
p1 <- bird_c %>% 
  ggplot(aes(x=Timestamp, y = xmid, color=batch))+ 
  geom_jitter(alpha = 0.5, show.legend = F) + 
  theme_pubr() + 
  labs(title = 'No Scaling Correction')

p2 <- bird_c %>% 
  mutate(xmid = ifelse(batch==1, xmid*1.2, xmid)) %>% 
  mutate(xmid = ifelse(batch==2, xmid*1.5, xmid)) %>% 
  mutate(xmid = ifelse(batch==3, xmid*1.5, xmid)) %>% 
  ggplot(aes(x=Timestamp, y = xmid, color=batch))+ 
  geom_jitter(alpha = 0.5, show.legend = F) + 
  theme_pubr() + 
  labs(title = 'With Scaling Correction')

# y direction
p3 <- bird_c %>%
  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ 
  geom_jitter(alpha = 0.5, show.legend = F) + 
  theme_pubr() 


p4 <- bird_c %>%
  mutate(ymid = ifelse(batch==1, ymid*1.3, ymid)) %>%
  mutate(ymid = ifelse(batch==2, ymid*1.4, ymid)) %>%
  mutate(ymid = ifelse(batch==3, ymid*1.4,  ymid)) %>%
  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ 
  geom_jitter(alpha = 0.5, show.legend = F) + 
  theme_pubr()


(p1 | p2) / (p3 | p4)
```

This isn't an ideal approach, and if we dig into the different distributions of xmin/xman and ymin/ymax, we can see that the assumptions we made based on the xmid/ymid values don't really extend to the min/max values. In a future version of this analysis, we could use the detection information for feeder location and shape, but for now we can proceed with this eyeballed version.

The batch lineup looks a lot better for both the scatterplot, and densities in any case! 

```{r, eval=F}

bird_c <- bird_c %>% 
  mutate(xmin = ifelse(batch==1, xmin*1.2, xmin)) %>% 
  mutate(xmin = ifelse(batch==2, xmin*1.5, xmin)) %>% 
  mutate(xmin = ifelse(batch==3, xmin*1.5, xmin)) %>% 
  mutate(ymin = ifelse(batch==1, ymin*1.3, ymin)) %>%
  mutate(ymin = ifelse(batch==2, ymin*1.4, ymin)) %>%
  mutate(ymin = ifelse(batch==3, ymin*1.4, ymin)) %>% 
  
  mutate(xmax = ifelse(batch==1, xmax*1.2, xmax)) %>% 
  mutate(xmax = ifelse(batch==2, xmax*1.5, xmax)) %>% 
  mutate(xmax = ifelse(batch==3, xmax*1.5, xmax)) %>% 
  mutate(ymax = ifelse(batch==1, ymax*1.3, ymax)) %>%
  mutate(ymax = ifelse(batch==2, ymax*1.4, ymax)) %>%
  mutate(ymax = ifelse(batch==3, ymax*1.4, ymax)) %>%
  
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2)

p1 <- bird_c %>%
  ggscatter(x='xmid', y = 'ymid', alpha=0.2, color='batch')
  

p2 <- bird_c %>%ggplot(aes(x=xmid, y=ymid, fill=batch)) + 
  stat_density_2d(geom = "polygon", alpha=0.2) + 
  theme_pubr()

(p1 | p2) + plot_annotation(title = 'Batch corrected bird location')

```

The gap in the middle comes from the water column - we can't detect birds sitting behind it!



```{r, eval=F}
img <- jpeg::readJPEG('feeder.jpg')

bird_c %>%
  ggplot(aes(x=xmid, y = ymid)) + 
  ylim(-80,400) + 
  background_image(img) + 
  geom_point()


```


### Bird size! 

and sizes of the birds in our images, we have to 


```{r, eval=F}
bird <- bird %>% 
  mutate(
         xmid = (xmax+xmin)/2, 
         ymid = (ymax+ymin)/2,
         Width = xmax - xmin, 
         Height = ymax - ymin
  )


bird %>%mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  ggscatter(x='Date', y='ymid')
```

```{r, eval=F}

# 
# how to make circle plot: pick center of box, plot x/y
# most interested in feet: on the left - feet are on the left. 
# if you're on the right, your feet are on the right. Could probably pick the center

# change female -> female + immature male

bird %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot() + 
  aes(x=xmid, y = Width, xmax, colour = Sex) +
  geom_point(alpha = 0.5) + 
  facet_wrap(~Species) +
  labs(title = 'Birds are wider on the sides of the feeder (profile view?)')

bird_c %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot(alpha = 0.5) + 
  aes(x=ymid, y = Height, xmax, colour = Sex) +
  geom_point() + 
  facet_wrap(~Species) +
  labs(title = 'Birds are taller near the top of the image')

bird_c %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot(alpha = 0.5) + 
  aes(x=xmid, y = Height, xmax, colour = Sex) +
  geom_point() + 
  facet_wrap(~Species) +
  labs(title = 'Annas are taller (and don\'t get captured sitting in the horizontal middle?)')

bird_c %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot(alpha = 0.5) + 
  aes(x=ymid, y = Width, xmax, colour = Sex) +
  geom_point() + 
  facet_wrap(~Species) +
  labs(title = 'Widest Rufous are in the (vertical) middle, widest Anna are near the top')

bird_c %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot(alpha = 0.5) + 
  aes(x=xmid, y = ymid, xmax, colour = Sex) +
  geom_point() + 
  facet_wrap(~Species) +
  labs(title = 'Birds mostly sit on the feeder. There may be one male anna who prefers the deck rail :)')

bird_c %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot(alpha = 0.5) + 
  aes(x=Width, y = Height, xmax, colour = Sex) +
  geom_point() + 
  facet_wrap(~Species) +
  labs(title = 'Wider birds are generally taller birds')
```


```{r, eval=F}

# number of birds per day 

bird_c %>% 
  group_by(Date, Species, Sex) %>%
  summarise(n=n(), `Temp C` = max(`Temp C`), .groups='keep') %>%
  ggplot() + 
  aes(x = Date, y = n, fill = Sex) + 
  geom_bar(stat = 'identity') +
  facet_wrap(~Species) + 
  labs(y = 'Number of bird visits', title = 'Most Rufous visit in Summer, Female Annas visit in Fall,\nMale Annas are year-round')

# Not really what happened

bird_c %>% 
  group_by(Date, Species, Sex) %>%
  summarise(n=n(), `Temp C` = max(`Temp C`), .groups='keep') %>%
  ggplot() + 
  aes(x = n, y = `Temp C`, colour = Sex) + 
  geom_point() + 
  geom_smooth(method = 'lm', formula = 'y~x', se = F, linetype='dashed') +
  facet_wrap(~Species, scales = 'free_x') + 
  labs(x = 'Number of bird visits', title = 'Everyone except Female Annas prefers lower temperatures')



```

# Number of birds in an image for each class

Rufous males can be very territorial. We'd like to know whether we can see evidence of the "chasing away" behaviour.

If this is the case, then the disappearance of the male rufous should lead to an increase in the *absolute number* of Annas who come (but might not affect the number of female rufous.  And the later disappearance of the female rufous should also lead to an increase in the number of Annas.

Because it's hard to see this on a minute-to-minute basis, we'll summarize the number of Anna visits by day.

```{r, eval=F}

# total number of birds per day
bird %>%
  filter(Species=='Annas') %>%
  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%
  group_by(Date,`Rufous Males present`, Sex, .groups='keep') %>%
  summarize(n=n()) %>%
  ggplot(aes(x=`Rufous Males present`, y = n)) +
  geom_rect(aes(fill = Sex),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, show.legend = F) + 
  geom_boxplot() + 
  facet_wrap("~Sex") + 
  stat_compare_means(method = "t.test", label.y = 180, label.x = 1.3) + 
  geom_bracket(xmin = 1, xmax = 2, label = '', y.position = c(170)) +
  theme_pubr() + 
  labs(title='Rufous Males are better at scaring off Female Annas than Male Annas') + 
  scale_fill_manual(values = c('chartreuse1', 'chartreuse4'))

# average number of birds per image per day
bird %>%
  filter(Species=='Annas') %>%
  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%
  
  group_by(Date,`Rufous Males present`, Timestamp, Sex, .groups='keep') %>%
  summarize(n=n()) %>%
  group_by(Date, `Rufous Males present`, Sex) %>%
  summarize(n=mean(n), .groups = 'keep') %>%
  
  ggplot(aes(x=`Rufous Males present`, y = n)) +
  geom_rect(aes(fill = Sex),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, show.legend = F) + 
  geom_boxplot() + 
  facet_wrap("~Sex") + 
  stat_compare_means(method = "t.test", label.y = 1.41, label.x = 1.3) + 
  geom_bracket(xmin = 1, xmax = 2, label = '', y.position = 1.4) +
  theme_pubr() + 
  labs(title='Rufous Males are better at scaring off Female Annas than Male Annas') + 
  scale_fill_manual(values = c('chartreuse1', 'chartreuse4'))


bird %>%
  group_by(Date, Timestamp, Species, .groups='keep') %>%
  summarize(n=n()) %>%
  #group_by(Date, Species) %>%
  #summarize(n=mean(n), .groups = 'keep') %>%
  ggplot(aes(x=factor(Date), y = n, colour=Species)) + 
  geom_point()+
  geom_smooth(aes(colour =Species), method='lm', formula='y~poly(x,4)')

bird %>%
  #filter(Species=='Annas') %>%
  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%
  group_by(Date, `Rufous Males present`, Species, Sex) %>%
  summarize(n=n()) %>%
  ggplot(aes(x=`Rufous Males present`, y = n)) +
  geom_boxplot() +
  facet_grid(rows =vars(Species), cols = vars(Sex), scales='free')



```

```{r, eval=F}
bird  %>%group_by(Timestamp, Species, Sex) %>% summarize(n=n()) %>% ggplot() +aes(x = Timestamp, y=n, color = Species, fill=Species) + geom_bar(stat='identity') + facet_wrap('~Sex') +scale_color_manual(values=c('chartreuse2', 'chocolate3'))+scale_fill_manual(values=c('chartreuse2', 'chocolate3'))
```

